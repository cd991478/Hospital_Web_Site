<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€êµ¬ COVID-19 í™˜ì ë¶„í¬</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
		body {
								    font-family: 'Pretendard', sans-serif;
								}
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border: 1px solid black;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <h2>ëŒ€êµ¬ ì§€ì—­ COVID-19 í™˜ì ë¶„í¬</h2>
    <svg id="map" width="800" height="600"></svg>

	<script>
	    document.addEventListener("DOMContentLoaded", function () {
	        const width = 800;
	        const height = 600;
	        const svg = d3.select("#map").attr("width", width).attr("height", height);

	        const projection = d3.geoMercator()
	            .center([128.6014, 35.8714])
	            .scale(50000)
	            .translate([width / 2, height / 2]);

	        const pathGenerator = d3.geoPath().projection(projection);

	        // âœ… ì§€ë„ ë°ì´í„° ë¡œë“œ
	        d3.json("/data/daegu.json")
	            .then(geoData => {
	                console.log("âœ… ëŒ€êµ¬ ì§€ë„ ë°ì´í„° ë¡œë“œ ì„±ê³µ:", geoData);

	                svg.selectAll("path")
	                    .data(geoData.features)
	                    .enter()
	                    .append("path")
	                    .attr("d", pathGenerator)
	                    .attr("fill", "#ddd")
	                    .attr("stroke", "#666")
	                    .on("mouseover", function () {
	                        d3.select(this).attr("fill", "#bbb");
	                    })
	                    .on("mouseout", function () {
	                        d3.select(this).attr("fill", "#ddd");
	                    });

	                // âœ… í™˜ì ë°ì´í„° ë¡œë“œ
	                fetch("/Chart/ShowPatientData")
	                    .then(response => response.json())
	                    .then(data => {
	                        if (!Array.isArray(data)) {
	                            throw new Error("ğŸš¨ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜: ë°°ì—´ì´ ì•„ë‹˜");
	                        }
	                        console.log("âœ… í™˜ì ë°ì´í„° ë¡œë“œ ì„±ê³µ:", data);

	                        // âœ… íˆ´íŒ ì¶”ê°€
	                        const tooltip = d3.select("body").append("div")
	                            .attr("class", "tooltip");

	                        // âœ… í™˜ì ìœ„ì¹˜ í‘œì‹œ
	                        const circles = svg.selectAll("circle")
	                            .data(data)
	                            .enter()
	                            .append("circle")
								.attr("cx", d => {
								    const lon = parseFloat(d.p_Longitude); // ê²½ë„
								    const lat = parseFloat(d.p_Latitude);  // ìœ„ë„
								    if (isNaN(lon) || isNaN(lat)) {
								        console.warn("ğŸš¨ ì˜ëª»ëœ ì¢Œí‘œ ê°’ (cx):", d.p_Longitude, d.p_Latitude, d);
								        return width / 2;
								    }
								    const coords = projection([lon, lat]);
								    return coords ? coords[0] : width / 2;
								})
								.attr("cy", d => {
								    const lon = parseFloat(d.p_Longitude); // ê²½ë„
								    const lat = parseFloat(d.p_Latitude);  // ìœ„ë„
								    if (isNaN(lon) || isNaN(lat)) {
								        console.warn("ğŸš¨ ì˜ëª»ëœ ì¢Œí‘œ ê°’ (cy):", d.p_Longitude, d.p_Latitude, d);
								        return height / 2;
								    }
								    const coords = projection([lon, lat]);
								    return coords ? coords[1] : height / 2;
								})

	                            .attr("r", d => {
	                                let age = parseInt(d.pAge, 10);
	                                let baseSize = !isNaN(age) ? Math.max(3, age / 10) : 3;

	                                // âœ… ê³ ìœ„í—˜êµ° (0~4)ì¸ ê²½ìš° í¬ê¸° ê°•ì¡°
	                                return (d.p_HighRiskGroup >= 0 && d.p_HighRiskGroup <= 4) ? baseSize + 3 : baseSize;
	                            })
	                            .attr("fill", d => {
	                                if (d.p_HighRiskGroup >= 0 && d.p_HighRiskGroup <= 4) {
	                                    return "darkred"; // âœ… ê³ ìœ„í—˜êµ° ê°•ì¡°
	                                }
	                                return d.pCovid19 ? "red" : "blue"; // í™•ì§„ìëŠ” ë¹¨ê°•, ë¹„í™•ì§„ìëŠ” íŒŒë‘
	                            })
	                            .attr("opacity", 0.7)
	                            .on("mouseover", function (event, d) {
	                                tooltip.html(`
	                                    <strong>${d.pName || "ì´ë¦„ ì—†ìŒ"}</strong><br>
	                                    ë‚˜ì´: ${d.p_Age}<br>
	                                    ì„±ë³„: ${d.p_Gender == 0 ? "ë‚¨" : "ì—¬"}<br>
	                                    ì½§ë¬¼/ì½”ë§‰í˜: ${d.p_Nose == 1 ? "ìœ " : "ë¬´"}<br>
	                                    ê¸°ì¹¨/ê°€ë˜: ${d.p_Cough == 1 ? "ìœ " : "ë¬´"}<br>
	                                    í†µì¦(ë‘í†µ/í‰í†µ/ê·¼ìœ¡í†µ ë“±): ${d.p_Pain == 1 ? "ìœ " : "ë¬´"}<br>
	                                    ì„¤ì‚¬: ${d.p_Diarrhea == 1 ? "ìœ " : "ë¬´"}<br>
	                                    í•´ì—´/ì§„í†µì œ ë³µìš© ìœ ë¬´: ${d.p_TakingPill == 1 ? "ìœ " : "ë¬´"}<br>
	                                    ê³ ìœ„í—˜êµ° ë¶„ë¥˜: ${d.p_HighRiskGroup == 0 ? "59ê°œì›” ì´í•˜ì˜ ì†Œì•„" :
	                                        d.p_HighRiskGroup == 1 ? "ì„ì‚°ë¶€" :
	                                        d.p_HighRiskGroup == 2 ? "ë§Œì„± íì§ˆí™˜" :
	                                        d.p_HighRiskGroup == 3 ? "ë‹¹ë‡¨" :
	                                        d.p_HighRiskGroup == 4 ? "ì•”í™˜ì" :
	                                        "í•´ë‹¹ì‚¬í•­ì—†ìŒ"}
	                                `)
	                                .style("left", (event.pageX + 10) + "px")
	                                .style("top", (event.pageY - 10) + "px")
	                                .style("visibility", "visible");
	                            })
	                            .on("mousemove", function (event) {
	                                tooltip.style("left", (event.pageX + 10) + "px")
	                                    .style("top", (event.pageY - 10) + "px");
	                            })
	                            .on("mouseout", function () {
	                                tooltip.style("visibility", "hidden");
	                            });
	                    })
	                    .catch(error => {
	                        console.error("ğŸš¨ í™˜ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
	                        alert("í™˜ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	                    });
	            })
	            .catch(error => {
	                console.error("ğŸš¨ ì§€ë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
	                alert("ì§€ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	            });
	    });
	</script>
</body>
</html>
