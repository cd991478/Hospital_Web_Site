<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™˜ì ì •ë³´ íŠ¸ë¦¬</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background: #f9f9f9;
        }
        .container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        svg {
            border: 1px solid #ddd;
            background: white;
        }
        .node circle {
            fill: #4CAF50;
            stroke: #000;
            stroke-width: 1.5px;
            cursor: pointer;
        }
        .node text {
            font-size: 12px;
            fill: black;
        }
        .link {
            fill: none;
            stroke: #999;
            stroke-width: 1.5px;
        }
        /* íˆ´íŒ ìŠ¤íƒ€ì¼ ìµœì í™” */
        .tooltip {
            position: absolute;
            text-align: left;
            width: auto;
            max-width: 600px;
            max-height: 500px;
            padding: 12px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
            white-space: normal;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>í™˜ì ì •ë³´ íŠ¸ë¦¬</h1>
    <div class="container">
        <svg width="800" height="600"></svg>
    </div>

    <!-- íˆ´íŒ ìš”ì†Œ -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        async function fetchPatientTree() {
            try {
                const response = await fetch("/api/patient/tree");
                if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");

                const treeData = await response.json();
                if (!treeData || Object.keys(treeData).length === 0) {
                    throw new Error("íŠ¸ë¦¬ ë°ì´í„° ì—†ìŒ");
                }

                renderTree(treeData);
            } catch (error) {
                console.error("íŠ¸ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        function renderTree(treeData) {
            const width = 800, height = 600;
            const svg = d3.select("svg"),
                  g = svg.append("g").attr("transform", "translate(50,50)");

            const hierarchyData = d3.hierarchy(treeData, d => [d.left, d.right].filter(n => n)); 
            const treeLayout = d3.tree().size([width - 100, height - 150]);
            const tree = treeLayout(hierarchyData);

            // íˆ´íŒ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const tooltip = d3.select("#tooltip");

            // ë§í¬(ì„ ) ì¶”ê°€
            g.selectAll(".link")
                .data(tree.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.linkVertical()
                    .x(d => d.x)
                    .y(d => d.y)
                );

            // ë…¸ë“œ ì¶”ê°€
            const node = g.selectAll(".node")
                .data(tree.descendants())
                .enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            node.append("circle")
                .attr("r", 10)
                .on("mouseover", function (event, d) {
                    tooltip.style("opacity", 1)
                        .html(`
                            <div style="text-align: left; padding: 10px; background: rgba(0, 0, 0, 0.9); 
                                        color: #fff; border-radius: 8px; max-width: 600px; max-height: 500px;
                                        overflow-y: auto; white-space: normal; word-wrap: break-word;">
										<b>ì´ë¦„:</b> ${d.data.P_Name || "ì•Œ ìˆ˜ ì—†ìŒ"}<br>
										<b>ID:</b> ${d.data.P_Id || "N/A"}<br>
										<b>ì „í™”ë²ˆí˜¸:</b> ${d.data.P_Phone || "N/A"}<br>
										<b>ì£¼ì†Œ:</b> ${d.data.P_Address1 || "N/A"} ${d.data.P_Address2 || ""}<br>
										<b>ì„±ë³„:</b> ${d.data.P_Gender === 0 ? "ë‚¨":"ì—¬"}<br>
										<b>ğŸ”¹ ì¦ìƒ ì •ë³´</b><br>
										<b>- ê°ê¸°:</b> ${d.data.P_Cough === 1 ? "ìœ " : "ë¬´"}<br>
										<b>- ì„¤ì‚¬:</b> ${d.data.P_Diarrhea === 1 ? "ìœ " : "ë¬´"}<br>
										<b>- í†µì¦(ë‘í†µ/í‰í†µ/ê·¼ìœ¡í†µ ë“±):</b> ${d.data.P_Pain === 1 ? "ìœ " : "ë¬´"}<br>
										<b>- ì½§ë¬¼/ì½”ë§‰í˜:</b> ${d.data.P_Nose === 1 ? "ìœ " : "ë¬´"}<br>
										<b>- ì§„í†µì œ ë³µìš©:</b> ${d.data.P_TakingPill === 1 ? "ìœ " : "ë¬´"}<br><br>

										<b>ğŸ”¹ ìœ„í—˜ ìš”ì†Œ</b><br>
										<b>- ê³ ìœ„í—˜êµ° ì—¬ë¶€:</b> ${d.data.P_HighRiskGroup === 0 ? "59ê°œì›” ì´í•˜ì˜ ì†Œì•„": 
															   d.data.P_HighRiskGroup === 1 ? "ì„ì‚°ë¶€" : 
															   d.data.P_HighRiskGroup === 2 ? "íì§ˆí™˜" :
															   d.data.P_HighRiskGroup === 3 ? "ë‹¹ë‡¨"  :
                                                               d.data.P_HighRiskGroup === 4 ? "ì•”í™˜ì" :
															   d.data.P_HighRiskGroup === 5 ? "í•´ë‹¹ì‚¬í•­ ì—†ìŒ":"ì•Œ ìˆ˜ ì—†ìŒ"}<br>
										<b>- í†µì¦ ìê°€ì²™ë„:</b> ${d.data.P_VAS}<br>
										<b>- ì½”ë¡œë‚˜ ê°ì—¼ì—¬ë¶€:</b> ${d.data.P_Covid19 == 1 ? "ìœ " :d.data.P_Covid19 == 0?  "ë¬´":"ëª¨ë¦„"}<br>

                            </div>
                        `);

                    // íˆ´íŒ ìœ„ì¹˜ ì¡°ì • (í™”ë©´ ëì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡)
                    let tooltipWidth = tooltip.node().offsetWidth;
                    let tooltipHeight = tooltip.node().offsetHeight;
                    let pageWidth = window.innerWidth;
                    let pageHeight = window.innerHeight;

                    let x = event.pageX + 15;
                    let y = event.pageY - 10;

                    if (x + tooltipWidth > pageWidth) {
                        x = event.pageX - tooltipWidth - 15;
                    }
                    if (y + tooltipHeight > pageHeight) {
                        y = event.pageY - tooltipHeight - 10;
                    }

                    tooltip.style("left", `${x}px`).style("top", `${y}px`);
                })
                .on("mousemove", function (event) {
                    let x = event.pageX + 15;
                    let y = event.pageY - 10;
                    let tooltipWidth = tooltip.node().offsetWidth;
                    let tooltipHeight = tooltip.node().offsetHeight;
                    let pageWidth = window.innerWidth;
                    let pageHeight = window.innerHeight;

                    if (x + tooltipWidth > pageWidth) {
                        x = event.pageX - tooltipWidth - 15;
                    }
                    if (y + tooltipHeight > pageHeight) {
                        y = event.pageY - tooltipHeight - 10;
                    }

                    tooltip.style("left", `${x}px`).style("top", `${y}px`);
                })
                .on("mouseout", function () {
                    tooltip.style("opacity", 0);
                });

            node.append("text")
                .attr("dy", -15)
                .attr("text-anchor", "middle")
                .text(d => `${d.data.P_Id || "N/A"}: ${d.data.P_Name || "ì´ë¦„ ì—†ìŒ"}`);
        }

        window.onload = fetchPatientTree;
    </script>
</body>
</html>

